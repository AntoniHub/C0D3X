# This workflow will install Python dependencies, run tests and lint with a single version of Python
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python
name: Daily Test

on:
  schedule:
    - cron: '*/10 * * * 1-5'
    
  # workflow_dispatch:

jobs:
  test_friday:
    if: github.event.schedule == '*/10 * * * 1-5'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10"]
    defaults:
      run:
        working-directory: "Jenkins-CI"
    env:
      API_KEY: ${{ secrets.API_KEY }}

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Install Python dependencies
      uses: py-actions/py-dependency-install@v4
      with:
        update-pip: "true"
        update-setuptools: "true"
        update-wheel: "true"
        path: "Jenkins-CI/requirements.txt"
      
    - name: Config ServiceAccountKey.json
      uses: jsdaniell/create-json@v1.2.3
      with:
        name: "serviceAccountKey.json"
        json: ${{ secrets.ACCOUNT_KEY }}
        dir: "Jenkins-CI"
            
    - name: Run API Tests
      run: python -m test_daily
      
    - name: Upload report .HTML
      uses: actions/upload-artifact@v4
      with:
        name: api_backend.html
        path: "Jenkins-CI/daily_test.html"
        
    - name: Push .HTML to Repo
      uses: actions-x/commit@v6
      with:
         email: abgrodriguezfarias@gmail.com
         name: Antonio Rodriguez Farias
         message: download .HTML to see report
         branch: master
         files: .
         repository: https://github.com/AntoniHub/C0D3X.git
         token: ${{ secrets.PAT }}
         force: true
         directory: "Jenkins-CI"

    - name: Create Issue
      uses: imjohnbo/issue-bot@v3
      with:
        assignees: "AntoniHub"
        title: Antonio Rodriguez Farias
        body: |-
          :wave: Hi, I am {{#each assignees}}@{{this}}{{#unless @last}}, {{/unless}}{{/each}}!

          üöÄ About me
          Software QA Engineer with experience in Frontend, Backend, Continuous Integration, Databases (SQL and NoSQL), UX/UI, Mobile, Architecture, Linux / macOS / Windows testing.
          üìä Master Degree in Big Data - Catholic University of Avila
          üîí Post Graduate Diploma in Defensive Cybersecurity
          üí° Diploma in Machine Learning | AI applied to Business
          üìå Continuous Testing with GitHub Actions
          üìå API Testing with Postman & Python
          üìå Frontend Testing with Selenium WebDriver
          üìå Backend Testing with Pytest, SQL & NoSQL
          üìå Linux Testing with Vagrant & VirtualBox
          üìå Mobile Testing with Android SDK & iOS
          üìù I write in depth on my website about myself rodriguezfarias.com
        pinned: false
        token: ${{ secrets.PAT }}

    - name: Push .HTML to t1
      uses: actions-x/commit@v6
      with:
         email: abgrodriguezfarias@gmail.com
         name: Antonio Rodriguez Farias
         message: download .HTML to see report
         branch: master
         files: .
         repository: https://github.com/AntoniHub/C0D3X.git
         token: ${{ secrets.PAT }}
         force: true
         directory: "Jenkins-CI/test/t1"

    - name: Push .HTML to t2
      uses: actions-x/commit@v6
      with:
         email: abgrodriguezfarias@gmail.com
         name: Antonio Rodriguez Farias
         message: download .HTML to see report
         branch: master
         files: .
         repository: https://github.com/AntoniHub/C0D3X.git
         token: ${{ secrets.PAT }}
         force: true
         directory: "Jenkins-CI/test/t2"

    - name: Push .HTML to t3
      uses: actions-x/commit@v6
      with:
         email: abgrodriguezfarias@gmail.com
         name: Antonio Rodriguez Farias
         message: download .HTML to see report
         branch: master
         files: .
         repository: https://github.com/AntoniHub/C0D3X.git
         token: ${{ secrets.PAT }}
         force: true
         directory: "Jenkins-CI/test/t3"

    - name: Push .HTML to t4
      uses: actions-x/commit@v6
      with:
         email: abgrodriguezfarias@gmail.com
         name: Antonio Rodriguez Farias
         message: download .HTML to see report
         branch: master
         files: .
         repository: https://github.com/AntoniHub/C0D3X.git
         token: ${{ secrets.PAT }}
         force: true
         directory: "Jenkins-CI/test/t4"

    - name: Push .HTML to t5
      uses: actions-x/commit@v6
      with:
         email: abgrodriguezfarias@gmail.com
         name: Antonio Rodriguez Farias
         message: download .HTML to see report
         branch: master
         files: .
         repository: https://github.com/AntoniHub/C0D3X.git
         token: ${{ secrets.PAT }}
         force: true
         directory: "Jenkins-CI/test/t5"

    - name: Push .HTML to t6
      uses: actions-x/commit@v6
      with:
         email: abgrodriguezfarias@gmail.com
         name: Antonio Rodriguez Farias
         message: download .HTML to see report
         branch: master
         files: .
         repository: https://github.com/AntoniHub/C0D3X.git
         token: ${{ secrets.PAT }}
         force: true
         directory: "Jenkins-CI/test/t6"

    - name: Push .HTML to t7
      uses: actions-x/commit@v6
      with:
         email: abgrodriguezfarias@gmail.com
         name: Antonio Rodriguez Farias
         message: download .HTML to see report
         branch: master
         files: .
         repository: https://github.com/AntoniHub/C0D3X.git
         token: ${{ secrets.PAT }}
         force: true
         directory: "Jenkins-CI/test/t7"

    - name: Push .HTML to t8
      uses: actions-x/commit@v6
      with:
         email: abgrodriguezfarias@gmail.com
         name: Antonio Rodriguez Farias
         message: download .HTML to see report
         branch: master
         files: .
         repository: https://github.com/AntoniHub/C0D3X.git
         token: ${{ secrets.PAT }}
         force: true
         directory: "Jenkins-CI/test/t8"

    - name: Push .HTML to t9
      uses: actions-x/commit@v6
      with:
         email: abgrodriguezfarias@gmail.com
         name: Antonio Rodriguez Farias
         message: download .HTML to see report
         branch: master
         files: .
         repository: https://github.com/AntoniHub/C0D3X.git
         token: ${{ secrets.PAT }}
         force: true
         directory: "Jenkins-CI/test/t9"

    - name: Push .HTML to t10
      uses: actions-x/commit@v6
      with:
         email: abgrodriguezfarias@gmail.com
         name: Antonio Rodriguez Farias
         message: download .HTML to see report
         branch: master
         files: .
         repository: https://github.com/AntoniHub/C0D3X.git
         token: ${{ secrets.PAT }}
         force: true
         directory: "Jenkins-CI/test/t10"


# For Pull Request
    - name: Push .HTML to Repo
      uses: actions-x/commit@v6
      with:
        email: abgrodriguezfarias@gmail.com
        name: Antonio Rodriguez Farias
        message: download .HTML to see report
        branch: test
        files: daily_test.html
        repository: https://github.com/AntoniHub/C0D3X.git
        token: ${{ secrets.PAT }}
        force: true
        directory: "Jenkins-CI"

    - name: Create Pull Request
      uses: repo-sync/pull-request@v2
      with:
        destination_branch: "master"
        source_branch: "test"
        github_token: ${{ secrets.PAT }}
        pr_title: "Test"
        pr_body: "Test"
        pr_label: "autoumated-pr"
